name: Pre-release and Changelog

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
        - build
      prerelease:
        description: 'Create as pre-release'
        required: true
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}-${{ github.sha }}
  cancel-in-progress: true

jobs:
  prepare:
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    outputs:
      tag_name: ${{ steps.get_tag.outputs.tag_name }}
      version: ${{ steps.get_tag.outputs.version }}
      is_prerelease: ${{ steps.release_type.outputs.is_prerelease }}
      changelog: ${{ steps.read_changelog.outputs.changelog }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ========== è·å–å½“å‰ç‰ˆæœ¬ ==========
      - name: Get current version from Git tag
        id: get_version
        run: |
          # è·å–æœ€æ–°çš„tag
          $latestTag = git describe --tags --abbrev=0 2>$null
          if ($latestTag) {
            # ç§»é™¤v/bå‰ç¼€
            $version = $latestTag -replace "^[vb]", ""
            echo "Found latest tag: $latestTag"
          } else {
            # å¦‚æœæ²¡æœ‰tagï¼Œä½¿ç”¨é»˜è®¤å€¼
            $version = "1.0.0.0"
            echo "No tag found, using default version: $version"
          }
          echo "current_version=$version" >> $env:GITHUB_OUTPUT
          echo "Current version: $version"

      # ========== å¤„ç†ç‰ˆæœ¬å·å’Œæ ‡ç­¾å ==========
      - name: Get tag name and version
        id: get_tag
        run: |
          if ("${{ github.event_name }}" -eq "push") {
            # ä» push tag äº‹ä»¶è·å–åŸå§‹æ ‡ç­¾å
            $tagName = "${{ github.ref }}".Replace("refs/tags/", "")
            # ç§»é™¤ v/b å‰ç¼€è·å–çº¯ç‰ˆæœ¬å·
            $cleanVersion = $tagName -replace "^[vb]", ""
            
            echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
            echo "version=$cleanVersion" >> $env:GITHUB_OUTPUT
            echo "Using pushed tag: $tagName, version: $cleanVersion"
          } else {
            # ä» workflow_dispatch è®¡ç®—æ–°ç‰ˆæœ¬ï¼ˆ4ä½æ ¼å¼ï¼‰
            $currentVersion = "${{ steps.get_version.outputs.current_version }}"
            $versionParts = $currentVersion.Split('.')
            
            # ç¡®ä¿ç‰ˆæœ¬å·æ ¼å¼æ­£ç¡®ï¼ˆè‡³å°‘4éƒ¨åˆ†ï¼‰
            if ($versionParts.Length -ge 4) {
              $major = [int]$versionParts[0]
              $minor = [int]$versionParts[1]
              $patch = [int]$versionParts[2]
              $build = [int]$versionParts[3]
            } else {
              # å¦‚æœç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¡¥å……ä¸º4ä½
              if ($versionParts.Length -ge 3) {
                $major = [int]$versionParts[0]
                $minor = [int]$versionParts[1]
                $patch = [int]$versionParts[2]
                $build = 0
              } else {
                # å¦‚æœç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®ï¼ŒæŠ›å‡ºé”™è¯¯
                echo "Error: Invalid version format. Expected format: x.y.z.w (e.g., 1.7.18.0)"
                exit 1
              }
            }
            
            $versionType = "${{ github.event.inputs.version_type }}"
            $isPrerelease = "${{ github.event.inputs.prerelease }}" -eq "true"
            
            switch ($versionType) {
              "major" { 
                $major++
                $minor = 0
                $patch = 0
                $build = 0
              }
              "minor" { 
                $minor++
                $patch = 0
                $build = 0
              }
              "patch" { 
                $patch++
                $build = 0
              }
              "build" { 
                $build++
              }
            }
            
            # ç”Ÿæˆæ–°ç‰ˆæœ¬å·ï¼ˆ4ä½æ ¼å¼ï¼Œå¦‚1.7.18.0ï¼‰
            $newVersion = "$major.$minor.$patch.$build"
            
            # æ ¹æ®æ˜¯å¦ä¸ºé¢„å‘å¸ƒå†³å®šæ ‡ç­¾å‰ç¼€
            if ($isPrerelease) {
              $tagName = "b$newVersion"
            } else {
              $tagName = "v$newVersion"
            }
            
            echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
            echo "version=$newVersion" >> $env:GITHUB_OUTPUT
            echo "New tag: $tagName, version: $newVersion"
          }

      - name: Determine release type
        id: release_type
        run: |
          if ("${{ github.event_name }}" -eq "push") {
            # æ ¹æ® tag åç§°å‰ç¼€ç¡®å®šæ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
            $tagName = "${{ steps.get_tag.outputs.tag_name }}"
            if ($tagName -and $tagName.StartsWith("b")) {
              echo "is_prerelease=true" >> $env:GITHUB_OUTPUT
              echo "This is a pre-release (beta)"
            } else {
              echo "is_prerelease=false" >> $env:GITHUB_OUTPUT
              echo "This is a release"
            }
          } else {
            # workflow_dispatch æ–¹å¼
            echo "is_prerelease=${{ github.event.inputs.prerelease }}" >> $env:GITHUB_OUTPUT
          }

      # ========== ä½¿ç”¨ git-cliff ç”Ÿæˆå˜æ›´æ—¥å¿— ==========
      - name: Generate changelog with git-cliff
        id: git_cliff
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml  # ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„ cliff.toml é…ç½®
          args: --latest --tag ${{ steps.get_tag.outputs.tag_name }} --output CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Read changelog content
        id: read_changelog
        run: |
          $changelogContent = Get-Content -Path CHANGELOG.md -Raw
          echo "changelog<<EOF" >> $env:GITHUB_OUTPUT
          echo $changelogContent >> $env:GITHUB_OUTPUT
          echo "EOF" >> $env:GITHUB_OUTPUT

  build:
    needs: prepare
    if: success()
    runs-on: windows-latest
    outputs:
      archive_name: ${{ steps.create_archive.outputs.archive_name }}
      zip_size: ${{ steps.calculate_size.outputs.zip_size }}
      zip_hash: ${{ steps.calculate_size.outputs.zip_hash }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2.0.1

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Cache NuGet packages and obj files
        id: cache-nuget
        uses: actions/cache@v4
        with:
          path: |
            # NuGet å…¨å±€åŒ…ç¼“å­˜ï¼ˆå·²ä¸‹è½½çš„åŒ…ï¼‰
            ~/.nuget/packages
            # NuGet ç¼“å­˜ç›®å½•ï¼ˆåŒ…ç´¢å¼•ï¼‰
            ~\AppData\Local\NuGet\Cache
            # é¡¹ç›® obj ç›®å½•ï¼ˆåŒ…å« project.assets.jsonï¼‰
            Ink Canvas/obj/
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/packages.config', '**/*.sln') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore NuGet packages (if cache missed)
        if: steps.cache-nuget.outputs.cache-hit != 'true'
        run: |
          Write-Host "ğŸ“¥ ç¼“å­˜æœªå‘½ä¸­ï¼Œæ­£åœ¨æ¢å¤ NuGet åŒ…..." -ForegroundColor Yellow
          
          # æ¢å¤è§£å†³æ–¹æ¡ˆçº§åˆ«çš„åŒ…
          nuget restore "Ink Canvas.sln" -Verbosity minimal
          
          # æ¢å¤é¡¹ç›®çº§åˆ«çš„åŒ…
          msbuild -t:restore "Ink Canvas/InkCanvasForClass.csproj" /p:GitFlow="Github Action" /p:RestorePackagesConfig=true /verbosity:minimal
          
          Write-Host "âœ… NuGet åŒ…æ¢å¤å®Œæˆ" -ForegroundColor Green

      - name: Display version info
        run: |
          echo "Building version: ${{ needs.prepare.outputs.version }}"
          echo "Tag: ${{ needs.prepare.outputs.tag_name }}"
          echo "Release type: ${{ needs.prepare.outputs.is_prerelease == 'true' && 'Pre-release' || 'Release' }}"
          
      - name: Build the Solution
        run: |
          Write-Host "ğŸ”¨ æ­£åœ¨æ„å»ºé¡¹ç›®..." -ForegroundColor Cyan
          msbuild /p:platform="AnyCPU" /p:configuration="Release" /p:GitFlow="Github Action" "Ink Canvas/InkCanvasForClass.csproj" /m /p:UseMultiToolTask=true /p:EnforceProcessCountAcrossBuilds=true /verbosity:minimal
          
          Write-Host "ğŸ—ï¸ æ„å»ºå‘½ä»¤æ‰§è¡Œå®Œæˆ" -ForegroundColor Cyan
          
      - name: Create Release Archive
        id: create_archive
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          $archiveName = "InkCanvasForClass.CE.$version.zip"
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          New-Item -ItemType Directory -Path "release" -Force
          
          # å¤åˆ¶å‘å¸ƒæ–‡ä»¶
          Copy-Item "Ink Canvas\bin\Release\net472\*" "release\" -Recurse -Force
          
          # åˆ›å»ºå‹ç¼©åŒ…
          Compress-Archive -Path "release\*" -DestinationPath $archiveName -Force
          
          echo "archive_name=$archiveName" >> $env:GITHUB_OUTPUT
          
      - name: Calculate archive size and hash
        id: calculate_size
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          $archiveName = "InkCanvasForClass.CE.$version.zip"
          
          # è·å–æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
          $fileSize = (Get-Item $archiveName).Length
          
          # è®¡ç®—SHA256å“ˆå¸Œ
          $hash = (Get-FileHash $archiveName -Algorithm SHA256).Hash
          
          echo "zip_size=$fileSize" >> $env:GITHUB_OUTPUT
          echo "zip_hash=$hash" >> $env:GITHUB_OUTPUT
          
          echo "Archive size: $fileSize bytes"
          echo "SHA256 hash: $hash"
          
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files-${{ needs.prepare.outputs.version }}
          path: |
            InkCanvasForClass.CE.${{ needs.prepare.outputs.version }}.zip

  sign:
    needs: [prepare, build]
    if: success()
    runs-on: ubuntu-latest  # æ”¹ä¸º Ubuntu ä»¥ä½¿ç”¨ Python ç­¾åå·¥å…·
    outputs:
      signatures_created: ${{ steps.sign_artifacts.outputs.signatures_created }}
      sigstore_file: "InkCanvasForClass.CE.${{ needs.prepare.outputs.version }}.zip.sigstore.json"
      sigstore_hash: ${{ steps.calculate_sig_hash.outputs.sigstore_hash }}
    
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files-${{ needs.prepare.outputs.version }}
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Sign release artifacts with sigstore-python
        id: sign_artifacts
        uses: sigstore/gh-action-sigstore-python@v3.2.0
        with:
          inputs: |
            InkCanvasForClass.CE.${{ needs.prepare.outputs.version }}.zip
          release-signing-artifacts: true
          upload-signing-artifacts: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Check generated signature files
        run: |
          version="${{ needs.prepare.outputs.version }}"
          echo "Checking for generated signature files..."
          ls -la *.sig* || true
          echo "Current directory contents:"
          pwd
          ls -la
          
      - name: Calculate signature hash
        id: calculate_sig_hash
        run: |
          version="${{ needs.prepare.outputs.version }}"
          sigstoreFile="InkCanvasForClass.CE.$version.zip.sigstore.json"
          
          if [ -f "$sigstoreFile" ]; then
            # è®¡ç®—SHA256å“ˆå¸Œ
            sigstoreHash=$(sha256sum "$sigstoreFile" | cut -d' ' -f1)
            
            echo "sigstore_hash=$sigstoreHash" >> $GITHUB_OUTPUT
            echo "Sigstore JSON file hash: $sigstoreHash"
            echo "Sigstore file size: $(stat -c%s "$sigstoreFile") bytes"
          else
            echo "Warning: Sigstore file not found: $sigstoreFile"
            echo "sigstore_hash=" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload Signed Artifacts
        if: steps.calculate_sig_hash.outputs.sigstore_hash != ''
        uses: actions/upload-artifact@v4
        with:
          name: signed-files-${{ needs.prepare.outputs.version }}
          path: |
            InkCanvasForClass.CE.${{ needs.prepare.outputs.version }}.zip.sigstore.json

  release:
    needs: [prepare, build, sign]
    if: success()
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # éœ€è¦è¿™ä¸ªæƒé™æ¥éªŒè¯ç­¾å
    
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files-${{ needs.prepare.outputs.version }}
          
      - name: Download Signed Artifacts (if exists)
        uses: actions/download-artifact@v4
        with:
          name: signed-files-${{ needs.prepare.outputs.version }}
          continue-on-error: true
          
      - name: Verify signatures (if sigstore file exists)
        if: hashFiles('InkCanvasForClass.CE.${{ needs.prepare.outputs.version }}.zip.sigstore.json') != ''
        run: |
          version="${{ needs.prepare.outputs.version }}"
          zipFile="InkCanvasForClass.CE.$version.zip"
          sigstoreFile="$zipFile.sigstore.json"
          
          if [ -f "$sigstoreFile" ]; then
            echo "Verifying signature for $zipFile using sigstore bundle..."
            
            # ä½¿ç”¨ sigstore-python éªŒè¯ç­¾å
            python -m sigstore verify \
              "$zipFile" \
              --bundle "$sigstoreFile" \
              --cert-identity "https://github.com/${{ github.repository }}/.github/workflows/prerelease.yml@${{ github.ref_name }}" \
              --cert-oidc-issuer "https://token.actions.githubusercontent.com"
            
            echo "âœ… Sigstore signature verified successfully!"
          else
            echo "âš ï¸ No sigstore bundle found, skipping signature verification"
          fi
          
      - name: Setup Python for verification
        if: hashFiles('InkCanvasForClass.CE.${{ needs.prepare.outputs.version }}.zip.sigstore.json') != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install sigstore for verification
        if: hashFiles('InkCanvasForClass.CE.${{ needs.prepare.outputs.version }}.zip.sigstore.json') != ''
        run: |
          python -m pip install sigstore
          
      - name: Create enhanced changelog with file table
        id: enhanced_changelog
        run: |
          version="${{ needs.prepare.outputs.version }}"
          
          # è¯»å–git-cliffç”Ÿæˆçš„changelogå†…å®¹
          originalChangelog="${{ needs.prepare.outputs.changelog }}"
          
          # æ„å»ºæ–‡ä»¶ä¿¡æ¯è¡¨æ ¼
          fileTable="\n## æ–‡ä»¶ä¿¡æ¯ (File Information)\n\n"
          fileTable+="| æ–‡ä»¶å | å¤§å° | SHA256 å“ˆå¸Œ |\n"
          fileTable+="|--------|------|-------------|\n"
          
          # ZIP æ–‡ä»¶ä¿¡æ¯
          fileTable+="| InkCanvasForClass.CE.$version.zip | ${{ needs.build.outputs.zip_size }} bytes | ${{ needs.build.outputs.zip_hash }} |\n"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç­¾åæ–‡ä»¶
          if [ -f "InkCanvasForClass.CE.$version.zip.sigstore.json" ]; then
            sigstoreSize=$(stat -c%s "InkCanvasForClass.CE.$version.zip.sigstore.json")
            sigstoreHash=$(sha256sum "InkCanvasForClass.CE.$version.zip.sigstore.json" | cut -d' ' -f1)
            fileTable+="| InkCanvasForClass.CE.$version.zip.sigstore.json | $sigstoreSize bytes | $sigstoreHash |\n"
          fi
          
          fileTable+="\n*æ–‡ä»¶å“ˆå¸Œå’Œå¤§å°ä¿¡æ¯ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*"
          
          # å°†è¡¨æ ¼é™„åŠ åˆ°åŸå§‹changelog
          enhancedChangelog="${originalChangelog}${fileTable}"
          
          # è¾“å‡ºå¢å¼ºç‰ˆchangelogå†…å®¹
          echo "enhanced_changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$enhancedChangelog" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "Enhanced changelog created with file information table"
          
      - name: Display Release Info
        run: |
          echo "=== Creating Release ==="
          echo "Version: ${{ needs.prepare.outputs.version }}"
          echo "Tag: ${{ needs.prepare.outputs.tag_name }}"
          echo "Pre-release: ${{ needs.prepare.outputs.is_prerelease }}"
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          name: ICC CE ${{ needs.prepare.outputs.version }}
          body: |
            ${{ steps.enhanced_changelog.outputs.enhanced_changelog }}
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          files: |
            InkCanvasForClass.CE.${{ needs.prepare.outputs.version }}.zip
            InkCanvasForClass.CE.${{ needs.prepare.outputs.version }}.zip.sigstore.json
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}