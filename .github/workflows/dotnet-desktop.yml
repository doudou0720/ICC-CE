name: .NET Build & PR Check

on:
  push:
    branches: [ main, beta ]
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'Images/**'
      - 'Manual.md'
      - 'README.md'
      - 'UpdateLog.md'
      - 'CODE_OF_CONDUCT.md'
      - 'LICENSE'
      - 'privacy.txt'
      - 'icc.png'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  prepare:
    name: Prepare Build
    runs-on: windows-latest
    outputs:
      build_time: ${{ steps.build-info.outputs.build_time }}
      commit_hash: ${{ steps.build-info.outputs.commit_hash }}
      build_number: ${{ steps.build-info.outputs.build_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2
      - name: Set build information
        id: build-info
        env:
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: |
          $buildTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
          $commitHash = $env:GITHUB_SHA.SubString(0, 7)
          
          echo "build_time=$buildTime" >> $env:GITHUB_OUTPUT
          echo "commit_hash=$commitHash" >> $env:GITHUB_OUTPUT
          echo "build_number=$env:GITHUB_RUN_NUMBER" >> $env:GITHUB_OUTPUT
          
          echo "æ„å»ºä¿¡æ¯å·²è®¾ç½®:"
          echo "  æ—¶é—´: $buildTime"
          echo "  æäº¤: $commitHash"
          echo "  ç¼–å·: $env:GITHUB_RUN_NUMBER"

  pr-preview-comment:
    name: PR Preview (Building)
    needs: prepare
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Prepare Preview Comment
        id: prepare-preview
        env:
          GH_REPO: ${{ github.repository }}
          GH_RUN_ID: ${{ github.run_id }}
          GH_SHA: ${{ github.sha }}
          BUILD_TIME: ${{ needs.prepare.outputs.build_time }}
        run: |
          # æ„å»ºé¢„è§ˆè¯„è®ºå†…å®¹ï¼Œä½¿ç”¨æ–‡ä»¶ç¡®ä¿æ¢è¡Œ
          {
            echo "ğŸ—ï¸ **æ­£åœ¨æ„å»ºä¸­...**"
            echo ""
            echo "| çŠ¶æ€ | æäº¤ | å¼€å§‹æ—¶é—´ | æ“ä½œ |"
            echo "|------|------|---------|------|"
            echo "| ğŸŸ¡ Building | $GH_SHA | $BUILD_TIME | [æŸ¥çœ‹è¿è¡Œè¯¦æƒ…](https://github.com/$GH_REPO/actions/runs/$GH_RUN_ID) |"
            echo ""
            echo "<sub>ğŸ¤– æ„å»ºå®Œæˆåï¼ŒçŠ¶æ€å°†è‡ªåŠ¨æ›´æ–°</sub>"
          } > preview_comment.txt
          
          # è¾“å‡ºå¤šè¡Œå†…å®¹
          preview_content=$(cat preview_comment.txt)
          delimiter="PREVIEW_$(date +%s)"
          echo "preview_body<<$delimiter" >> $GITHUB_OUTPUT
          echo "$preview_content" >> $GITHUB_OUTPUT
          echo "$delimiter" >> $GITHUB_OUTPUT
          
          echo "é¢„è§ˆè¯„è®ºå†…å®¹å·²å‡†å¤‡"
      - name: Post Preview Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.prepare-preview.outputs.preview_body }}
          edit-mode: replace

  build-and-package:
    name: Build & Package
    needs: prepare
    runs-on: windows-latest
    outputs:
      archive_name: ${{ steps.create-archive.outputs.archive_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2.0.1
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\NuGet\Cache
            ~\AppData\Local\Microsoft\MSBuild
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
      - name: Restore and Build
        run: |
          nuget restore "Ink Canvas.sln"
          msbuild /p:platform="AnyCPU" /p:configuration="Debug" /p:GitFlow="Github Action" "Ink Canvas/InkCanvasForClass.csproj"
      - name: Create Package
        id: create-archive
        env:
          GITHUB_SHA: ${{ github.sha }}
          PREPARE_BUILD_NUMBER: ${{ needs.prepare.outputs.build_number }}
        run: |
          $version = "debug-$env:GITHUB_SHA-$env:PREPARE_BUILD_NUMBER"
          $archiveName = "InkCanvasForClass.CE.$version.zip"
          Compress-Archive -Path "Ink Canvas\bin\Debug\net472\*" -DestinationPath $archiveName -Force
          echo "archive_name=$archiveName" >> $env:GITHUB_OUTPUT
          echo "å·²åˆ›å»ºå½’æ¡£åŒ…: $archiveName"
      - name: Upload Artifact
        uses: actions/upload-artifact@v4.5.0
        with:
          name: app-package
          path: "*.zip"

  pr-check-comment:
    name: PR Check & Comment (Final)
    needs: [build-and-package, pr-preview-comment]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Find Existing Preview Comment
        uses: peter-evans/find-comment@v3
        id: find-existing-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'æ­£åœ¨æ„å»ºä¸­'
          
      - name: Prepare Final Comment Content
        id: prepare-final-comment
        env:
          GH_REPO: ${{ github.repository }}
          GH_RUN_ID: ${{ github.run_id }}
          GH_SHA: ${{ github.sha }}
          BUILD_TIME: ${{ needs.prepare.outputs.build_time }}
          BUILD_RESULT: ${{ needs.build-and-package.result }}
        run: |
          # ç¡®å®šæ„å»ºçŠ¶æ€
          if [ "$BUILD_RESULT" = "success" ]; then
            STATUS_ICON="âœ…"
            STATUS_TEXT="æˆåŠŸ"
          else
            STATUS_ICON="âŒ"
            STATUS_TEXT="å¤±è´¥"
          fi
          
          # å¤„ç†æ—¶é—´å˜é‡ï¼Œé˜²æ­¢ç©ºç™½
          FINAL_BUILD_TIME="${BUILD_TIME}"
          if [ -z "$FINAL_BUILD_TIME" ]; then
            FINAL_BUILD_TIME="æœªçŸ¥æ—¶é—´"
            echo "æç¤ºï¼šBUILD_TIME ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼"
          fi
          
          # æ„å»ºæœ€ç»ˆè¯„è®ºå†…å®¹ï¼Œä½¿ç”¨æ–‡ä»¶ç¡®ä¿æ­£ç¡®æ¢è¡Œ
          {
            echo "# æ„å»ºå®Œæˆ $STATUS_ICON"
            echo ""
            echo "| çŠ¶æ€ | æäº¤ | å®Œæˆæ—¶é—´ | æ“ä½œ |"
            echo "|------|------|----------|------|"
            echo "| $STATUS_ICON $STATUS_TEXT | $GH_SHA | $FINAL_BUILD_TIME | [æŸ¥çœ‹è¿è¡Œè¯¦æƒ…](https://github.com/$GH_REPO/actions/runs/$GH_RUN_ID) |"
            echo ""
            echo "<sub>ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨å‘å¸ƒ</sub>"
          } > final_comment.txt
          
          # è¾“å‡ºå¤šè¡Œå†…å®¹
          final_content=$(cat final_comment.txt)
          delimiter="FINAL_$(date +%s)"
          echo "final_body<<$delimiter" >> $GITHUB_OUTPUT
          echo "$final_content" >> $GITHUB_OUTPUT
          echo "$delimiter" >> $GITHUB_OUTPUT
          
          echo "æœ€ç»ˆè¯„è®ºå†…å®¹å·²ç”Ÿæˆ"
          echo "æ„å»ºçŠ¶æ€: $STATUS_ICON $STATUS_TEXT"
          echo "æ„å»ºæ—¶é—´: $FINAL_BUILD_TIME"
          
      - name: Update to Final Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-existing-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.prepare-final-comment.outputs.final_body }}
          edit-mode: replace