name: .NET Build

on:
  push:
    branches: [ main, beta ]
  pull_request:
    branches: [ main ]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
      - "Images/**"
      - "Manual.md"
      - "README.md"
      - "UpdateLog.md"
      - "CODE_OF_CONDUCT.md"
      - "LICENSE"
      - "privacy.txt"
      - "icc.png"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  prepare:
    name: Prepare Build
    runs-on: windows-latest
    outputs:
      build_time: ${{ steps.build-info.outputs.build_time }}
      commit_hash: ${{ steps.build-info.outputs.commit_hash }}
      build_number: ${{ steps.build-info.outputs.build_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Set build information
        id: build-info
        run: |
          echo "build_time=$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $env:GITHUB_OUTPUT
          echo "commit_hash=$("${{ github.sha }}".SubString(0, 7))" >> $env:GITHUB_OUTPUT
          echo "build_number=${{ github.run_number }}" >> $env:GITHUB_OUTPUT
          
      - name: Display build info
        run: |
          echo "Build time: ${{ steps.build-info.outputs.build_time }}"
          echo "Commit hash: ${{ steps.build-info.outputs.commit_hash }}"
          echo "Build number: ${{ steps.build-info.outputs.build_number }}"

  restore:
    name: Restore Dependencies
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2.0.1

      - name: Cache NuGet tools
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\NuGet\Cache
            ~\AppData\Local\Microsoft\MSBuild
          key: ${{ runner.os }}-nuget-tools-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-tools-

      - name: Restore NuGet Packages
        run: nuget restore "Ink Canvas.sln"

      - name: Cache restored packages
        uses: actions/cache@v4
        with:
          path: '~\AppData\Local\NuGet\Cache'
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}

  build:
    name: Build Application
    needs: [prepare, restore]
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Restore NuGet tools from cache
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\NuGet\Cache
            ~\AppData\Local\Microsoft\MSBuild
          key: ${{ runner.os }}-nuget-tools-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-tools-

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore NuGet packages from cache
        uses: actions/cache@v4
        with:
          path: '~\AppData\Local\NuGet\Cache'
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}

      - name: Build the Solution
        run: |
          msbuild -t:restore /p:GitFlow="Github Action"
          msbuild /p:platform="AnyCPU" /p:configuration="Debug" /p:GitFlow="Github Action" "Ink Canvas/InkCanvasForClass.csproj"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4.5.0
        with:
          name: InkCanvasForClass-Build
          path: "Ink Canvas/bin/Debug/net472"

  package:
    name: Package Application
    needs: build
    runs-on: windows-latest
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: InkCanvasForClass-Build
          path: build-output

      - name: Create release archive
        run: |
          $version = "debug-${{ github.sha }}-${{ needs.prepare.outputs.build_number }}"
          $archiveName = "InkCanvasForClass.CE.$version.zip"
          Compress-Archive -Path "build-output\*" -DestinationPath $archiveName -Force
          echo "archive_name=$archiveName" >> $env:GITHUB_OUTPUT

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4.5.0
        with:
          name: InkCanvasForClass-Package
          path: "*.zip"

      - name: Generate build summary
        run: |
          echo "## Build Summary" >> $env:GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $env:GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| Build time | ${{ needs.prepare.outputs.build_time }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Commit hash | ${{ needs.prepare.outputs.commit_hash }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Build number | ${{ needs.prepare.outputs.build_number }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Archive | ${{ github.workspace }}/*.zip |" >> $env:GITHUB_STEP_SUMMARY
          
          echo "### Artifacts" >> $env:GITHUB_STEP_SUMMARY
          echo "Created package: ${{ github.workspace }}/*.zip" >> $env:GITHUB_STEP_SUMMARY
          
  comment-pr:
    name: Comment on PR
    needs: [prepare, build, package]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Find Existing Comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '# æ„å»ºå†å²è®°å½•'

      - name: Format status
        id: status
        run: |
          if [ "${{ needs.package.result }}" = "success" ]; then
            echo "icon=âœ…" >> $GITHUB_OUTPUT
            echo "text=æˆåŠŸ" >> $GITHUB_OUTPUT
          else
            echo "icon=âŒ" >> $GITHUB_OUTPUT
            echo "text=å¤±è´¥" >> $GITHUB_OUTPUT
          fi
          
      - name: Build Previous Entries
        id: prev
        if: steps.find-comment.outputs.comment-id != ''
        run: |
          comment_url="https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ steps.find-comment.outputs.comment-id }}"
          prev_entries=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$comment_url" | \
            jq -r '.body' | \
            grep '^| ' | \
            grep -v '^| çŠ¶æ€ | æäº¤ | æ„å»ºäº§ç‰© |' | \
            head -n 15)
          echo "entries<<EOF" >> $GITHUB_OUTPUT
          echo "$prev_entries" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Count the number of previous builds
          build_count=$(echo "$prev_entries" | grep -c '^| ')
          echo "build_count=$build_count" >> $GITHUB_OUTPUT
          
      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            # æ„å»ºå†å²è®°å½• ${{ steps.status.outputs.icon }}
            
            | çŠ¶æ€ | æäº¤ | æ„å»ºäº§ç‰© | æ„å»ºæ—¶é—´ | æ“ä½œ |
            |------|------|---------|---------|------|
            | ${{ steps.status.outputs.icon }} ${{ steps.status.outputs.text }} | ${{ github.sha }}<br>ï¼ˆå½“å‰æäº¤ï¼‰ | ${{ needs.package.result == 'success' && '[ğŸ“¦ ä¸‹è½½](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})' || 'æ— ' }} | ${{ needs.prepare.outputs.build_time }} | [æŸ¥çœ‹è¯¦æƒ…](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
            ${{ steps.prev.outputs.entries }}
            
            ${{ steps.prev.outputs.build_count > 5 && '_ğŸ’¡ æç¤º: å¦‚æœæ‚¨ä»åœ¨è¿›è¡Œå¼€å‘æ›´æ”¹ï¼Œå¯ä»¥è€ƒè™‘å°†æ­¤ PR è½¬æ¢ä¸º Draft_' || ''}}
            
            ---
            <sub>ğŸ¤– è¿™æ˜¯ç”± GitHub Actions è‡ªåŠ¨å‘å¸ƒçš„è¯„è®ºã€‚å¦‚æœ‰é—®é¢˜è¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…ã€‚</sub>
          edit-mode: replace