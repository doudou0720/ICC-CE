name: .NET Build & PR Check

on:
  push:
    branches: [ main, beta ]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'Images/**'
      - 'Manual.md'
      - 'README.md'
      - 'UpdateLog.md'
      - 'CODE_OF_CONDUCT.md'
      - 'LICENSE'
      - 'privacy.txt'
      - 'icc.png'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  find-or-create-pr-comment:
    name: Find or Create PR Comment
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    outputs:
      comment_id: ${{ steps.find-comment.outputs.comment_id }}
    steps:
      - name: Find existing bot comment
        id: find-comment
        run: |
          # æŸ¥æ‰¾åŒ…å«ç‰¹å®šæ ‡è®°çš„ç°æœ‰è¯„è®º
          COMMENTS=$(gh api \
            -H "Accept: application/vnd.github.v3+json" \
            "/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            --jq '.[] | select(.body | contains("<!-- github-action-pr-build -->")) | .id' | head -1)
          
          if [ -n "$COMMENTS" ]; then
            echo "ğŸ“ æ‰¾åˆ°ç°æœ‰è¯„è®º ID: $COMMENTS"
            echo "comment_id=$COMMENTS" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ æœªæ‰¾åˆ°ç°æœ‰è¯„è®ºï¼Œå°†åˆ›å»ºæ–°è¯„è®º"
            echo "comment_id=" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  pr-preview-comment:
    name: PR Preview (Building)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: find-or-create-pr-comment
    permissions:
      pull-requests: write
    steps:
      - name: Prepare Preview Comment
        id: prepare-preview
        env:
          GH_REPO: ${{ github.repository }}
          GH_RUN_ID: ${{ github.run_id }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          IS_READY_FOR_REVIEW: ${{ github.event.action == 'ready_for_review' }}
        run: |
          # æ„å»ºé¢„è§ˆè¯„è®ºå†…å®¹
          {
            if [ "$IS_READY_FOR_REVIEW" = "true" ]; then
              echo "# ğŸš€ PR å‡†å¤‡å®¡æŸ¥ - æ„å»ºé¢„è§ˆ"
              echo ""
              echo "**çŠ¶æ€:** ğŸŸ¡ æ­£åœ¨æ„å»ºï¼ˆå‡†å¤‡å®¡æŸ¥çŠ¶æ€ï¼‰..."
            else
              echo "# ğŸ—ï¸ PR æ„å»ºé¢„è§ˆ"
              echo ""
              echo "**çŠ¶æ€:** ğŸŸ¡ æ­£åœ¨æ„å»º..."
            fi
            
            echo "**åˆ†æ”¯æäº¤:** \`$PR_HEAD_SHA\`"
            echo "**æ“ä½œ:** [æŸ¥çœ‹è¿è¡Œè¯¦æƒ…](https://github.com/$GH_REPO/actions/runs/$GH_RUN_ID)"
            echo ""
            
            if [ "$IS_READY_FOR_REVIEW" = "true" ]; then
              echo "> ğŸ“‹ æ­¤ PR å·²æ ‡è®°ä¸º **å‡†å¤‡å®¡æŸ¥**ï¼Œæ­£åœ¨è¿›è¡Œæ„å»ºéªŒè¯"
            fi
            
            echo "---"
            echo "<!-- github-action-pr-build -->"
            echo "<!-- build-id: $GH_RUN_ID -->"
            echo "<!-- event-type: ${{ github.event.action }} -->"
            echo "<!-- pr-head-sha: $PR_HEAD_SHA -->"
            echo "<!-- merge-sha: ${{ github.sha }} -->"
            echo "ğŸ¤– æ„å»ºå®Œæˆåï¼ŒçŠ¶æ€å°†è‡ªåŠ¨æ›´æ–°"
          } > preview_comment.txt
          
          preview_content=$(cat preview_comment.txt)
          echo "preview_body<<EOF" >> $GITHUB_OUTPUT
          echo "$preview_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Post/Update Preview Comment
        id: create-preview-comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ needs.find-or-create-pr-comment.outputs.comment_id }}
          body: ${{ steps.prepare-preview.outputs.preview_body }}
          edit-mode: replace

  build-and-package:
    name: Build & Package
    runs-on: windows-latest
    outputs:
      archive_name: ${{ steps.create-archive.outputs.archive_name }}
      build_result: ${{ steps.check-exe.outputs.build_success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2.0.1

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Cache NuGet packages and obj files
        id: cache-nuget
        uses: actions/cache@v4
        with:
          path: |
            # NuGet å…¨å±€åŒ…ç¼“å­˜ï¼ˆå·²ä¸‹è½½çš„åŒ…ï¼‰
            ~/.nuget/packages
            # NuGet ç¼“å­˜ç›®å½•ï¼ˆåŒ…ç´¢å¼•ï¼‰
            ~\AppData\Local\NuGet\Cache
            # é¡¹ç›® obj ç›®å½•ï¼ˆåŒ…å« project.assets.jsonï¼‰
            Ink Canvas/obj/
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/packages.config', '**/*.sln') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore NuGet packages (if cache missed)
        if: steps.cache-nuget.outputs.cache-hit != 'true'
        run: |
          Write-Host "ğŸ“¥ ç¼“å­˜æœªå‘½ä¸­ï¼Œæ­£åœ¨æ¢å¤ NuGet åŒ…..." -ForegroundColor Yellow
          
          # æ¢å¤è§£å†³æ–¹æ¡ˆçº§åˆ«çš„åŒ…
          nuget restore "Ink Canvas.sln" -Verbosity minimal
          
          # æ¢å¤é¡¹ç›®çº§åˆ«çš„åŒ…
          msbuild -t:restore "Ink Canvas/InkCanvasForClass.csproj" /p:GitFlow="Github Action" /p:RestorePackagesConfig=true /verbosity:minimal
          
          Write-Host "âœ… NuGet åŒ…æ¢å¤å®Œæˆ" -ForegroundColor Green

      - name: Build the Solution
        run: |
          Write-Host "ğŸ”¨ æ­£åœ¨æ„å»ºé¡¹ç›®..." -ForegroundColor Cyan
          
          # å¦‚æœæ˜¯ ready_for_review äº‹ä»¶ï¼Œæ·»åŠ ç‰¹æ®Šæ ‡è®°
          if ("${{ github.event.action }}" -eq "ready_for_review") {
            Write-Host "ğŸš€ PR å‡†å¤‡å®¡æŸ¥çŠ¶æ€æ„å»º - è¿›è¡Œå®Œæ•´éªŒè¯" -ForegroundColor Magenta
            $GITFLOW = "Github Action - Ready For Review"
          } else {
            $GITFLOW = "Github Action"
          }
          
          # æ‰§è¡Œæ„å»º
          msbuild /p:platform="AnyCPU" /p:configuration="Debug" /p:GitFlow="$GITFLOW" "Ink Canvas/InkCanvasForClass.csproj" /m /p:UseMultiToolTask=true /p:EnforceProcessCountAcrossBuilds=true /verbosity:minimal
          
          Write-Host "ğŸ—ï¸ æ„å»ºå‘½ä»¤æ‰§è¡Œå®Œæˆ" -ForegroundColor Cyan

      - name: Check if exe file is generated
        id: check-exe
        run: |
          Write-Host "ğŸ” æ£€æŸ¥æ˜¯å¦ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶..." -ForegroundColor Cyan
          
          $exePath = "Ink Canvas\bin\Debug\net472\InkCanvasForClass.exe"
          
          if (Test-Path $exePath) {
            Write-Host "âœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $exePath" -ForegroundColor Green
            $fileInfo = Get-Item $exePath
            Write-Host "   æ–‡ä»¶å¤§å°: $($fileInfo.Length) å­—èŠ‚" -ForegroundColor Gray
            Write-Host "   åˆ›å»ºæ—¶é—´: $($fileInfo.CreationTime)" -ForegroundColor Gray
            echo "build_success=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $exePath" -ForegroundColor Red
            Write-Host "   æ£€æŸ¥ç›®å½•å†…å®¹:" -ForegroundColor Yellow
            if (Test-Path "Ink Canvas\bin\Debug\net472\") {
              Get-ChildItem "Ink Canvas\bin\Debug\net472\" -ErrorAction SilentlyContinue | ForEach-Object {
                Write-Host "   - $($_.Name)" -ForegroundColor Gray
              }
            } else {
              Write-Host "   bin\Debug\net472 ç›®å½•ä¸å­˜åœ¨" -ForegroundColor Red
            }
            echo "build_success=false" >> $env:GITHUB_OUTPUT
            
            # å¦‚æœæ˜¯ç›´æ¥è§¦å‘ï¼Œåˆ™æŠ›å‡ºé”™è¯¯
            if ("${{ github.event_name }}" -eq "workflow_dispatch") {
              Write-Host "ğŸš¨ å·¥ä½œæµæ‰‹åŠ¨è§¦å‘ - æ„å»ºå¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯ï¼" -ForegroundColor Red -BackgroundColor Black
              exit 1
            }
          }

      - name: Create Package (if build succeeded)
        id: create-archive
        if: steps.check-exe.outputs.build_success == 'true'
        env:
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: |
          # ä½¿ç”¨åˆå¹¶æäº¤çš„çŸ­å“ˆå¸Œï¼ˆå› ä¸ºæ„å»ºä½¿ç”¨çš„æ˜¯åˆå¹¶åçš„ä»£ç ï¼‰
          $shortSha = $env:GITHUB_SHA.Substring(0, 7)
          $version = "debug-$shortSha-$env:GITHUB_RUN_NUMBER"
          $archiveName = "InkCanvasForClass.CE.$version.zip"
          Write-Host "ğŸ“¦ æ­£åœ¨åˆ›å»ºå½’æ¡£åŒ…: $archiveName" -ForegroundColor Cyan
          Write-Host "   ä½¿ç”¨åˆå¹¶æäº¤å“ˆå¸Œ: $env:GITHUB_SHA" -ForegroundColor Gray
          Compress-Archive -Path "Ink Canvas\bin\Debug\net472\*" -DestinationPath $archiveName -Force
          echo "archive_name=$archiveName" >> $env:GITHUB_OUTPUT
          Write-Host "âœ… å·²åˆ›å»ºå½’æ¡£åŒ…: $archiveName" -ForegroundColor Green
      
      - name: Upload Artifact (if build succeeded)
        if: steps.check-exe.outputs.build_success == 'true'
        uses: actions/upload-artifact@v4.5.0
        with:
          name: app-package
          path: "*.zip"

  pr-check-comment:
    name: PR Check & Comment (Final)
    needs: [build-and-package, find-or-create-pr-comment]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Prepare Final Comment Content
        id: prepare-final-comment
        run: |
          # ä»æ„å»ºä½œä¸šè·å–æ„å»ºç»“æœ
          BUILD_SUCCESS="${{ needs.build-and-package.outputs.build_result }}"
          
          # ä½¿ç”¨ PR åˆ†æ”¯çš„å®é™…æäº¤å“ˆå¸Œ
          PR_HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # ç¡®å®šæ„å»ºçŠ¶æ€
          if [ "$BUILD_SUCCESS" = "true" ]; then
            STATUS_ICON="âœ…"
            STATUS_TEXT="æ„å»ºæˆåŠŸ"
            COLOR="#00d26a"
          else
            STATUS_ICON="âŒ"
            STATUS_TEXT="æ„å»ºå¤±è´¥"
            COLOR="#f85149"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯ ready_for_review äº‹ä»¶
          READY_FOR_REVIEW="${{ github.event.action == 'ready_for_review' }}"
          
          # æ„å»ºæœ€ç»ˆè¯„è®ºå†…å®¹
          {
            if [ "$READY_FOR_REVIEW" = "true" ]; then
              echo "# ğŸš€ PR å‡†å¤‡å®¡æŸ¥ - æ„å»ºç»“æœ"
              echo ""
              echo "> ğŸ“‹ æ­¤ PR å·²æ ‡è®°ä¸º **å‡†å¤‡å®¡æŸ¥**ï¼Œæ„å»ºéªŒè¯å®Œæˆ"
              echo ""
            else
              echo "# ğŸ“‹ æ„å»ºç»“æœæ‘˜è¦"
              echo ""
            fi
            
            echo "## æœ¬æ¬¡æ„å»ºçŠ¶æ€"
            echo ""
            echo "| é¡¹ç›® | ç»“æœ |"
            echo "|------|------|"
            echo "| çŠ¶æ€ | $STATUS_ICON **$STATUS_TEXT** |"
            echo "| äº‹ä»¶ç±»å‹ | \`${{ github.event.action }}\` |"
            echo "| åˆ†æ”¯æäº¤ | \`$PR_HEAD_SHA\` |"
            echo "| å·¥ä½œæµ | [è¿è¡Œ #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |"
            
            # å¦‚æœæœ‰æ„å»ºäº§ç‰©ï¼Œæ˜¾ç¤ºä¸‹è½½é“¾æ¥
            if [ "$BUILD_SUCCESS" = "true" ]; then
              echo ""
              echo "## æ„å»ºäº§ç‰©"
              echo "- ğŸ“¦ [ä¸‹è½½æ„å»ºäº§ç‰©](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
              
              if [ "$READY_FOR_REVIEW" = "true" ]; then
                echo ""
                echo "## ğŸ‰ å®¡æŸ¥å»ºè®®"
                echo "- âœ… æ„å»ºéªŒè¯é€šè¿‡ï¼Œä»£ç å¯ä»¥æ­£å¸¸ç¼–è¯‘"
                echo "- ğŸ” è¯·è¿›è¡Œä»£ç å®¡æŸ¥"
                echo "- ğŸ§ª å»ºè®®æµ‹è¯•æ„å»ºäº§ç‰©åŠŸèƒ½"
              fi
            else
              if [ "$READY_FOR_REVIEW" = "true" ]; then
                echo ""
                echo "## âš ï¸ å®¡æŸ¥é˜»å¡"
                echo "- âŒ æ„å»ºå¤±è´¥ï¼Œéœ€è¦ä¿®å¤åæ‰èƒ½ç»§ç»­å®¡æŸ¥"
                echo "- ğŸ”§ è¯·æ£€æŸ¥æ„å»ºé”™è¯¯å¹¶ä¿®å¤"
                echo "- ğŸ“ ä¿®å¤åé‡æ–°æ ‡è®°ä¸ºå‡†å¤‡å®¡æŸ¥"
              fi
            fi
            
            echo ""
            echo "---"
            echo "<!-- github-action-pr-build -->"
            echo "<!-- build-id: ${{ github.run_id }} -->"
            echo "<!-- event-type: ${{ github.event.action }} -->"
            echo "<!-- pr-head-sha: $PR_HEAD_SHA -->"
            echo "<!-- merge-sha: ${{ github.sha }} -->"
            echo "<sub>ğŸ¤– GitHub Actions è‡ªåŠ¨ç”Ÿæˆ â€¢ æœ€åæ›´æ–°: $(date -u +'%Y-%m-%d %H:%M:%S UTC')</sub>"
          } > final_comment.txt
          
          # è¾“å‡ºå¤šè¡Œå†…å®¹
          final_content=$(cat final_comment.txt)
          echo "final_body<<EOF" >> $GITHUB_OUTPUT
          echo "$final_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "æœ€ç»ˆè¯„è®ºå†…å®¹å·²ç”Ÿæˆ"
      
      - name: Update Final Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ needs.find-or-create-pr-comment.outputs.comment_id }}
          body: ${{ steps.prepare-final-comment.outputs.final_body }}
          edit-mode: replace

  final-check:
    name: Final Check (Manual Trigger)
    if: always() && github.event_name == 'workflow_dispatch'
    needs: [build-and-package]
    runs-on: ubuntu-latest
    steps:
      - name: Check Build Result
        id: check-build
        run: |
          BUILD_SUCCESS="${{ needs.build-and-package.outputs.build_result }}"
          
          if [ "$BUILD_SUCCESS" = "true" ]; then
            echo "âœ… æ„å»ºæˆåŠŸ - å·¥ä½œæµå®Œæˆ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ„å»ºå¤±è´¥ - æŠ›å‡ºé”™è¯¯"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Create Summary (if successful)
        if: steps.check-build.outputs.status == 'success'
        run: |
          echo "# ğŸ‰ æ‰‹åŠ¨æ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ„å»ºçŠ¶æ€:** âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**è¿è¡Œç¼–å·:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[ğŸ“¦ ä¸‹è½½æ„å»ºäº§ç‰©](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY